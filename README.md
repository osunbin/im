# IM



只做出了大体架构、很多功能还未完成，但数据结构已经设计好。

entry接入层支持tcp、http，功能有了但代码细节还未完善，文档也不完善。个人开发比较麻烦。

想着不使用spring开发，结果过程比较痛苦、很多都需要自己处理,后续可能切换spring体系。





网页：http长轮询(拉取消息)；匿名-系统临时分配一个uid(cookie识别是否同一个匿名用户)



### 登录

账号验证与用户同步

* 登录
* 记录用户在线信息(server-redis,entry-内存)
* 是否其他地方登录过(剔除之前登录)
* 通知用户好友(通知在线用户)

用户登录拉取信息

* friend-getList
* friend-getInfo
* group-getList
* group-getInfo



| user_friend |       |          |      |
| ----------- | ----- | -------- | ---- |
| uid         | int64 | 用户id   |      |
| friend_id   | int64 | 好友列表 |      |

| user_info    |              |                                                              |           |
| ------------ | ------------ | ------------------------------------------------------------ | --------- |
| uid          | int64        |                                                              |           |
| nick_name    | varchar(254) |                                                              | 测试      |
| gender       | int(1)       |                                                              | 1-男 2-女 |
| birthday     | int32        |                                                              | 19700506  |
| time         | int64        |                                                              |           |
| open_level   | int32        | 用户信息的开发程度,那些人能查看我的信息-仅限好友、群组、禁止所有人、限制特定的人 |           |
| friend_level | int32        | 加好友认证-需要验证、不许允许别人添加                        |           |
| msg_policy   | int32        | 消息接收策略-允许所有人给我发消息,允许群成员发点对点信息，只有好友才能发点对点信息 |           |

| user_group(用户那有些群) |       |      |      |
| ------------------------ | ----- | ---- | ---- |
| uid                      | int64 |      |      |
| gid                      | int64 |      |      |

| group_info |               |                        |        |
| ---------- | ------------- | ---------------------- | ------ |
| gid        | int64         |                        | 12     |
| gname      | varchar(254)  |                        | 吹水群 |
| intro      | varchar(2045) |                        | 群公告 |
| time       | int64         | 时间戳(信息变化则更新) |        |
|            |               |                        |        |

| list_time   |       |                                    |      |
| ----------- | ----- | ---------------------------------- | ---- |
| uid         | int64 | 用户id                             |      |
| friend_list | int64 | 用户好友列表时间戳                 | 100  |
| group_list  | int64 | 用户群组列表时间戳(用户加入或推出) | 155  |



**拉取信息优化**

1）延迟拉取,按需拉取

 可以延迟拉取：好友的详细信息、群组的详细信息可以延迟拉取

不可以延迟拉取：列表元素，群组、好友列表

2）只拉取增量数据

​	时间戳->好友或群组新增或减少时list_time才会发送变化(版本号+1/时间戳)

* 拉取时间戳,与app本地存储的时间做对比

3）优化(2)客户端请求

```Json
{
	"uid":1,
    "friend_list":100,
    "group_list":100,
}
```



### 发消息

> client_msg_id 客户端生成的id是为了去重,



拉取离线消息

* 客户端一次性拉取所有未读消息,(分页)客户端自己分析那些是A-B,那些是C-B
* 分页拉取(ack是一页中最后的msgid)减少交换次数



### 好友状态

隐身、离线、忙碌、勿扰-> 客户端业务状态

好友状态：登录时是拉取

好友修改客户端状态：

* 定时轮询拉取(借助心跳)不够实时
* 实时推送(服务端压力大-消息风暴扩散)



### 群聊

需求

* 创建群
* 查看/修改群
* 加群/退群

| group_members(群成员) |      |               |      |
| --------------------- | ---- | ------------- | ---- |
| gid                   |      |               |      |
| uid                   |      |               |      |
| last_ack_msgid        |      | 最后ack的消息 |      |

```json
// 管理员邀请加入群(adminUid是否是群管理员,是否互为好友,addUid是否已经是群成员)
{
	"admin_uid":123,
    "add_uid":144,
    "gid":100
}

{
    "admin_uid":123,
    "add_uid":144,
     "gid":100,
    "result":"我不要"
}
```



| group_msgs |      |      |      |
| ---------- | ---- | ---- | ---- |
| msg_id     |      |      |      |
| gid        |      |      |      |
| sender_uid |      |      |      |
| time       |      |      |      |
| content    |      |      |      |



### 群消息已读

群已读 last_ack_msgid 可以批量修改数据(客户端定时推送last——magid),然后批量修改(问题服务崩溃导致重复msgid-去重)

| msg_acks   |      |      |          |
| ---------- | ---- | ---- | -------- |
| sender_uid |      |      | 123      |
| msg_id     |      |      | 243424   |
| recv_uid   |      |      | 456      |
| gid        |      |      | 100      |
| if_ack     |      |      | 回执标记 |

已读回执->通过客户端长轮询查看那些消息那些用户已读

群友在线状态->长轮询拉取





### 文件发送

小于1k复用IM发送消息通道

发送文件异步

* 上传文件系统
* 同时发送文件元数据信息消息
* 接收端去文件系统拉取(很可能文件还有没与上传完成,接收端轮询去查看文件是否上传成功)

大文件(100MB)P2P(客户端直连)



